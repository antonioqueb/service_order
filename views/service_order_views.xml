<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- =========================================================
       VISTA BÚSQUEDA (SEARCH) - ORDEN
       ========================================================= -->
  <record id="view_service_order_search" model="ir.ui.view">
    <field name="name">service.order.search</field>
    <field name="model">service.order</field>
    <field name="arch" type="xml">
      <search string="Buscar Orden de Servicio">
        <!-- Campos de búsqueda rápida -->
        <field name="name" string="Folio"/>
        <field name="partner_id" string="Cliente"/>
        
        <!-- NUEVO: BUSCAR POR SERVICIO DENTRO DE LA ORDEN 
             Esto permite escribir el nombre del servicio en la barra de búsqueda -->
        <field name="line_ids" string="Servicio / Residuo" 
               filter_domain="['|', ('line_ids.name', 'ilike', self), ('line_ids.product_id.name', 'ilike', self)]"/>

        <field name="user_id" string="Comercial"/>
        <field name="sale_order_id"/>
        <field name="transportista_id"/>
        <field name="generador_id"/>
        <field name="destinatario_id"/>
        <field name="numero_placa"/>
        <field name="partner_city" string="Ciudad Cliente"/>

        <separator/>

        <!-- Filtros Rápidos -->
        <filter string="Mis Órdenes" name="my_orders" domain="[('user_id', '=', uid)]"/>
        <separator/>
        <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
        <filter string="Confirmadas" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
        <filter string="Completadas" name="done" domain="[('state', '=', 'done')]"/>
        <filter string="Canceladas" name="cancel" domain="[('state', '=', 'cancel')]"/>
        <separator/>
        <filter string="Pendiente Facturar" name="to_invoice" domain="[('invoicing_status', '=', 'no'), ('state', '=', 'done')]"/>
        <separator/>
        
        <!-- Filtro de fecha estándar -->
        <filter string="Fecha Orden" name="filter_date_order" date="date_order"/>
        
        <!-- Agrupadores (Group By) -->
          <!-- Principales -->
          <filter string="Comercial" name="group_user" context="{'group_by': 'user_id'}"/>
          <filter string="Cliente" name="group_partner" context="{'group_by': 'partner_id'}"/>
          <filter string="Generador" name="group_generador" context="{'group_by': 'generador_id'}"/>
          
          <!-- NOTA: Se eliminó el group_by de line_ids.name aquí porque causaba el error RPC.
               Para ver el desglose por nombre en Pivot, se debe usar la vista de "Análisis de Residuos".
               Aquí solo podemos FILTRAR (Buscar), no Agrupar. -->
          
          <!-- Geográficos -->
          <filter string="Ciudad" name="group_city" context="{'group_by': 'partner_city'}"/>
          <filter string="Estado" name="group_state_id" context="{'group_by': 'partner_state_id'}"/>
          
          <!-- Logística -->
          <filter string="Transportista" name="group_transportista" context="{'group_by': 'transportista_id'}"/>
          <filter string="Destinatario" name="group_destinatario" context="{'group_by': 'destinatario_id'}"/>
          <filter string="Chofer" name="group_chofer" context="{'group_by': 'chofer_id'}"/>
          <filter string="Placa" name="group_placa" context="{'group_by': 'numero_placa'}"/>
          
          <!-- Otros -->
          <filter string="Estado Orden" name="group_state" context="{'group_by': 'state'}"/>
          <filter string="Mes" name="group_date_month" context="{'group_by': 'date_order:month'}"/>
          <filter string="Frecuencia" name="group_frequency" context="{'group_by': 'service_frequency'}"/>
      </search>
    </field>
  </record>

  <!-- =========================================================
       ACCIÓN PRINCIPAL (WINDOW ACTION) - ORDEN
       ========================================================= -->
  <record id="action_service_order" model="ir.actions.act_window">
    <field name="name">Órdenes de Servicio</field>
    <field name="res_model">service.order</field>
    <field name="view_mode">list,form,pivot,graph</field>
    <!-- Referencia a la vista Search -->
    <field name="search_view_id" ref="view_service_order_search"/>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Cree su primera Orden de Servicio
      </p>
    </field>
  </record>

  <!-- =========================================================
       ACCIÓN DE SERVIDOR: FACTURACIÓN MASIVA
       ========================================================= -->
  <record id="action_service_order_mass_invoice" model="ir.actions.server">
    <field name="name">Crear Factura</field>
    <field name="model_id" ref="model_service_order"/>
    <field name="binding_model_id" ref="model_service_order"/>
    <field name="binding_view_types">list</field>
    <field name="state">code</field>
    <field name="code">
      if records:
          action = records.action_create_invoice()
    </field>
  </record>

  <!-- =========================================================
       MENÚ RAÍZ
       ========================================================= -->
  <record id="menu_service_order_root" model="ir.ui.menu">
    <field name="name">Servicios</field>
    <field name="sequence">10</field>
    <field name="action" ref="action_service_order"/>
    <field name="web_icon">service_order,static/description/icon.png</field>
  </record>

  <!-- =========================================================
       VISTA PIVOT (TABLA DINÁMICA) - ORDEN
       ========================================================= -->
  <record id="view_service_order_pivot" model="ir.ui.view">
    <field name="name">service.order.pivot</field>
    <field name="model">service.order</field>
    <field name="arch" type="xml">
      <pivot string="Análisis de Órdenes de Servicio" sample="1">
        <!-- Filas (Rows) -->
        <field name="partner_id" type="row"/>
        
        <!-- Columnas (Cols) -->
        <field name="date_order" interval="month" type="col"/>

        <!-- Medidas -->
        <field name="total_weight_kg" type="measure" string="Peso (Kg)"/>
        <field name="total_product_qty" type="measure" string="Bultos/Cant."/>
        <field name="lines_count" type="measure" string="Nº Líneas"/>
        <field name="amount_untaxed" type="measure" string="Subtotal ($)"/>
        <field name="amount_tax" type="measure" string="Impuestos ($)"/>
        <field name="amount_total" type="measure" string="Total ($)"/>
      </pivot>
    </field>
  </record>

  <!-- =========================================================
       VISTA GRAPH - ORDEN
       ========================================================= -->
  <record id="view_service_order_graph" model="ir.ui.view">
    <field name="name">service.order.graph</field>
    <field name="model">service.order</field>
    <field name="arch" type="xml">
      <graph string="Ventas por Órdenes de Servicio" type="bar" sample="1">
        <field name="date_order" interval="month"/>
        <field name="total_weight_kg" type="measure"/>
      </graph>
    </field>
  </record>

  <!-- =========================================================
       VISTA LISTA - ORDEN
       ========================================================= -->
  <record id="view_service_order_list" model="ir.ui.view">
    <field name="name">service.order.list</field>
    <field name="model">service.order</field>
    <field name="type">list</field>
    <field name="arch" type="xml">
      <list string="Órdenes de Servicio" default_order="date_order desc">
        <field name="name" string="Folio" class="fw-bold"/>
        <field name="date_order" string="Fecha"/>
        <field name="partner_id" string="Cliente"/>
        <field name="user_id" string="Comercial" widget="many2one_avatar_user" optional="show"/>
        <field name="sale_order_id" string="Cotización" readonly="1" optional="hide"/>
        
        <!-- Columnas adicionales -->
        <field name="total_weight_kg" string="Peso Total" sum="Total Peso" optional="show"/>
        <field name="total_product_qty" string="Cant. Total" sum="Total Items" optional="hide"/>
        <field name="amount_total" string="Total ($)" sum="Total" optional="show" widget="monetary" decoration-bf="1"/>

        <field name="state" widget="badge"
               decoration-info="state == 'draft'"
               decoration-warning="state == 'confirmed'"
               decoration-success="state == 'done'"
               decoration-danger="state == 'cancel'"/>
        <field name="invoicing_status" string="Facturación" widget="badge"
               decoration-info="invoicing_status == 'no'"
               decoration-warning="invoicing_status == 'draft'"
               decoration-success="invoicing_status == 'invoiced'"
               decoration-primary="invoicing_status == 'paid'"/>
        
        <field name="currency_id" column_invisible="1"/>
      </list>
    </field>
  </record>

  <!-- =========================================================
       VISTA FORMULARIO - ORDEN
       ========================================================= -->
  <record id="view_service_order_form" model="ir.ui.view">
    <field name="name">service.order.form</field>
    <field name="model">service.order</field>
    <field name="type">form</field>
    <field name="arch" type="xml">
      <form string="Orden de Servicio">

        <header>
          <button name="action_confirm"
                  string="Confirmar"
                  type="object"
                  class="btn-primary"
                  invisible="state != 'draft'"/>

          <button name="action_set_done"
                  string="Marcar Completado"
                  type="object"
                  class="btn-secondary"
                  invisible="state != 'confirmed'"/>

          <button name="action_cancel"
                  string="Cancelar"
                  type="object"
                  class="btn-secondary"
                  invisible="state not in ['draft', 'confirmed', 'done'] or invoicing_status in ['invoiced', 'paid']"/>

          <button name="action_set_draft"
                  string="Restablecer a Borrador"
                  type="object"
                  class="btn-secondary"
                  invisible="state not in ['cancel', 'confirmed', 'done'] or invoicing_status in ['invoiced', 'paid']"/>

          <field name="state"
                 widget="statusbar"
                 statusbar_visible="draft,confirmed,done,cancel"/>
        </header>

        <sheet>
          <widget name="web_ribbon" title="Borrador" bg_color="text-bg-info" invisible="state != 'draft'"/>
          <widget name="web_ribbon" title="Confirmada" bg_color="text-bg-warning" invisible="state != 'confirmed'"/>
          <widget name="web_ribbon" title="Completada" bg_color="text-bg-success" invisible="state != 'done'"/>
          <widget name="web_ribbon" title="Cancelada" bg_color="text-bg-danger" invisible="state != 'cancel'"/>
          
          <widget name="web_ribbon" title="Pagado" bg_color="text-bg-primary" invisible="invoicing_status != 'paid'"/>
          <widget name="web_ribbon" title="Facturado" bg_color="text-bg-success" invisible="invoicing_status not in ['invoiced'] or invoicing_status == 'paid'"/>
          <widget name="web_ribbon" title="Fact. Borrador" bg_color="text-bg-warning" invisible="invoicing_status != 'draft'"/>

          <div class="oe_button_box" name="button_box">
            <button name="action_view_linked_invoices"
                    type="object"
                    class="oe_stat_button"
                    icon="fa-file-text-o"
                    invisible="invoice_count == 0">
              <field name="invoice_count" widget="statinfo" string="Facturas"/>
            </button>
          </div>

          <div class="oe_title">
            <h1>
              <field name="name" class="o_inline"/>
            </h1>
            <div class="text-muted">
              <span>Orden de servicio vinculada a </span>
              <field name="sale_order_id"
                     class="o_inline"
                     placeholder="Sin cotización"
                     readonly="1"
                     options="{'no_create': True}"/>
            </div>
          </div>

          <notebook>
            <page string="Resumen" name="page_summary">
              <group>
                <group string="Cliente y Referencias">
                  <field name="partner_id" options="{'no_create': True}" readonly="sale_order_id"/>
                  <field name="user_id" widget="many2one_avatar_user"/>

                  <field name="generador_id"
                         options="{'no_create': True}"
                         domain="[
                           '&amp;',
                             '|', ('parent_id', '=', partner_id), ('id', '=', partner_id),
                             ('category_id.name', 'ilike', 'Generador')
                         ]"
                         placeholder="(Sin contacto con etiqueta Generador)"/>

                  <field name="generador_responsable_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar contacto del cliente..."/>

                  <field name="destinatario_id"
                         options="{'no_create': True}"
                         domain="[('category_id.name', 'ilike', 'Destino Final')]"
                         placeholder="Seleccionar destinatario final..."/>

                  <field name="sale_order_id" string="Cotización" readonly="1" options="{'no_create': True}"/>
                  <field name="date_order"/>
                </group>

                <group string="Contacto y Recolección">
                  <field name="contact_partner_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar contacto del cliente..."/>

                  <field name="contact_phone" readonly="1"
                         placeholder="Se toma del contacto seleccionado"/>

                  <field name="pickup_location_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar ubicación de recolección..."/>

                  <field name="pickup_location" invisible="1"/>

                  <field name="transportista_id" string="Transportista" options="{'no_create': True}"/>

                  <field name="transportista_responsable_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', transportista_id), ('id', '=', transportista_id)]"
                         placeholder="Seleccionar contacto del transportista..."/>
                </group>
              </group>
            </page>

            <page string="Logística" name="page_logistics">
              <group>
                <group string="Unidad y Operador">
                  <field name="camion" string="Camión"/>
                  <field name="numero_placa" string="Placas"/>
                  <field name="chofer_id" string="Chofer" options="{'no_create': True}"/>
                </group>

                <group string="Remolques y Básculas">
                  <field name="remolque1" string="Remolque 1"/>
                  <field name="remolque2" string="Remolque 2"/>
                  <field name="bascula_1" string="Báscula 1"/>
                  <field name="bascula_2" string="Báscula 2"/>
                  <field name="numero_bascula" invisible="1"/>
                  
                  <div colspan="2" class="mt-4 border-top pt-2">
                     <label for="total_weight_kg" class="fw-bold"/> <field name="total_weight_kg" class="oe_inline fw-bold"/> kg<br/>
                     <label for="total_product_qty" class="fw-bold"/> <field name="total_product_qty" class="oe_inline fw-bold"/> items
                  </div>
                </group>
              </group>
            </page>

            <page string="Líneas de Servicio" name="page_lines">
              <field name="line_ids">
                <list editable="bottom">
                  <field name="product_id" string="Producto/Servicio" options="{'no_create': True}"/>
                  <field name="currency_id" column_invisible="1"/>

                  <field name="name" string="Equivalente / Descripción"/>
                  <field name="residue_type" string="Tipo" optional="hide"/>
                  <field name="plan_manejo" string="Plan de Manejo" optional="hide"/>
                  <field name="packaging_id" string="Embalaje"/>

                  <field name="price_unit"
                         string="Precio Unitario"
                         widget="monetary"
                         options="{'currency_field': 'currency_id'}"
                         invisible="not product_id"/>

                  <field name="capacity" string="Capacidad" invisible="not product_id"/>
                  <field name="weight_kg" string="Peso (kg)" sum="Total Kg" invisible="not product_id"/>
                  <field name="product_uom_qty" string="Cantidad" sum="Total Cantidad" invisible="not product_id"/>
                  <field name="product_uom" string="UoM" invisible="not product_id"/>
                </list>
              </field>
              
              <group class="oe_subtotal_footer oe_right">
                  <field name="amount_untaxed" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                  <field name="amount_tax" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                  <div class="oe_subtotal_footer_separator oe_inline">
                      <label for="amount_total"/>
                  </div>
                  <field name="amount_total" nolabel="1" class="oe_subtotal_footer_separator" widget="monetary" options="{'currency_field': 'currency_id'}"/>
              </group>
            </page>

            <page string="Observaciones" name="page_notes">
              <group string="Notas">
                <field name="observaciones"
                       nolabel="1"
                       placeholder="Ingrese observaciones adicionales..."
                       widget="text"/>
              </group>
            </page>

          </notebook>

        </sheet>
      </form>
    </field>
  </record>

  <!-- =========================================================
       NUEVO: ANÁLISIS DE RESIDUOS (LINE PIVOT/GRAPH)
       Esta sección permite reportar sobre TODAS las líneas
       ========================================================= -->

  <!-- 1. Vista Pivot para Líneas -->
  <record id="view_service_order_line_pivot" model="ir.ui.view">
    <field name="name">service.order.line.pivot</field>
    <field name="model">service.order.line</field>
    <field name="arch" type="xml">
      <pivot string="Análisis de Residuos" sample="1">
        <!-- Filas: El Residuo (Producto) -->
        <field name="product_id" type="row"/>
        <!-- NUEVO: Agregado nombre explícito para poder bajar el nivel de detalle -->
        <field name="name" type="row"/>
        
        <!-- Columnas: Tiempo -->
        <field name="date_order" interval="month" type="col"/>

        <!-- Medidas -->
        <field name="weight_kg" type="measure" string="Peso (Kg)"/>
        <field name="product_uom_qty" type="measure" string="Cantidad"/>
        <field name="price_subtotal" type="measure" string="Subtotal ($)"/>

        <!-- Campos adicionales disponibles -->
        <field name="partner_id"/>
        <field name="user_id"/>
        <field name="residue_type"/>
        <field name="plan_manejo"/>
        <field name="packaging_id"/>
        <field name="state"/>
        <!-- description es el computado, name es el manual -->
        <field name="description" string="Descripción (Comp)"/>
      </pivot>
    </field>
  </record>

  <!-- 2. Vista Graph para Líneas -->
  <record id="view_service_order_line_graph" model="ir.ui.view">
    <field name="name">service.order.line.graph</field>
    <field name="model">service.order.line</field>
    <field name="arch" type="xml">
      <graph string="Análisis Gráfico" type="bar" sample="1">
        <field name="date_order" interval="month"/>
        <field name="product_id"/>
        <field name="weight_kg" type="measure"/>
      </graph>
    </field>
  </record>

  <!-- 3. Vista Search para Líneas -->
  <record id="view_service_order_line_search" model="ir.ui.view">
    <field name="name">service.order.line.search</field>
    <field name="model">service.order.line</field>
    <field name="arch" type="xml">
      <search string="Buscar Residuos">
        <field name="product_id" string="Residuo/Servicio"/>
        <!-- NUEVO: Agregar nombre a la búsqueda -->
        <field name="name" string="Nombre de Servicio / Equivalente"/>
        <field name="description" string="Descripción Calculada"/>
        <field name="partner_id" string="Cliente"/>
        <field name="service_order_id" string="Orden de Servicio"/>
        <field name="residue_type"/>
        <field name="plan_manejo"/>
        
        <separator/>
        <filter string="Confirmadas/Completadas" name="confirmed_done" domain="[('state', 'in', ['confirmed', 'done'])]"/>
        <filter string="Pendientes" name="draft" domain="[('state', '=', 'draft')]"/>
        <separator/>
        <filter string="Este Mes" name="this_month" date="date_order"/>

            <filter string="Cliente" name="group_partner" context="{'group_by':'partner_id'}"/>
            <filter string="Residuo (Producto)" name="group_product" context="{'group_by':'product_id'}"/>
            
            <!-- AQUÍ SÍ FUNCIONA porque el modelo base es service.order.line -->
            <filter string="Nombre del Servicio" name="group_name" context="{'group_by':'name'}"/>
            
            <filter string="Descripción (Comp)" name="group_description" context="{'group_by':'description'}"/>
            <filter string="Tipo Residuo" name="group_type" context="{'group_by':'residue_type'}"/>
            <filter string="Plan de Manejo" name="group_plan" context="{'group_by':'plan_manejo'}"/>
            <filter string="Embalaje" name="group_pack" context="{'group_by':'packaging_id'}"/>
            <filter string="Fecha" name="group_date" context="{'group_by':'date_order:month'}"/>
            <filter string="Comercial" name="group_user" context="{'group_by':'user_id'}"/>
      </search>
    </field>
  </record>

  <!-- 4. Acción de Ventana (Reporte Líneas) -->
  <record id="action_service_order_line_analysis" model="ir.actions.act_window">
    <field name="name">Análisis Detallado de Líneas</field>
    <field name="res_model">service.order.line</field>
    <field name="view_mode">pivot,graph,list</field>
    <field name="search_view_id" ref="view_service_order_line_search"/>
    <field name="context">{'search_default_confirmed_done': 1}</field>
    <!-- SIN DOMAIN para que salgan todas las líneas, incluidas las sin producto -->
  </record>

  <!-- 5. Elemento de Menú para el Reporte -->
  <menuitem id="menu_service_order_analysis_root"
            name="Informes"
            parent="menu_service_order_root"
            sequence="20"/>

  <menuitem id="menu_service_order_residue_analysis"
            name="Análisis de Residuos"
            parent="menu_service_order_analysis_root"
            action="action_service_order_line_analysis"
            sequence="1"/>

</odoo>