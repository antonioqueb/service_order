<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- =========================================================
       ACCIÓN PRINCIPAL
       ========================================================= -->
  <record id="action_service_order" model="ir.actions.act_window">
    <field name="name">Órdenes de Servicio</field>
    <field name="res_model">service.order</field>
    <field name="view_mode">list,form</field>
  </record>

  <!-- =========================================================
       MENÚ RAÍZ
       ========================================================= -->
  <record id="menu_service_order_root" model="ir.ui.menu">
    <field name="name">Servicios</field>
    <field name="sequence">10</field>
    <field name="action" ref="action_service_order"/>
    <field name="web_icon">service_order,static/description/icon.png</field>
  </record>

  <!-- =========================================================
       VISTA LISTA
       ========================================================= -->
  <record id="view_service_order_list" model="ir.ui.view">
    <field name="name">service.order.list</field>
    <field name="model">service.order</field>
    <field name="type">list</field>
    <field name="arch" type="xml">
      <list string="Órdenes de Servicio" default_order="date_order desc">
        <field name="name" string="Folio" class="fw-bold"/>
        <field name="date_order" string="Fecha"/>
        <field name="partner_id" string="Cliente"/>
        <field name="sale_order_id" string="Cotización" readonly="1"/>
        <field name="state" widget="badge"
               decoration-info="state == 'draft'"
               decoration-warning="state == 'confirmed'"
               decoration-success="state == 'done'"
               decoration-danger="state == 'cancel'"/>
        <field name="invoicing_status" string="Facturación" widget="badge"
               decoration-success="invoicing_status == 'invoiced'"
               decoration-info="invoicing_status == 'no'"/>
      </list>
    </field>
  </record>

  <!-- =========================================================
       VISTA FORMULARIO
       ========================================================= -->
  <record id="view_service_order_form" model="ir.ui.view">
    <field name="name">service.order.form</field>
    <field name="model">service.order</field>
    <field name="type">form</field>
    <field name="arch" type="xml">
      <form string="Orden de Servicio">

        <header>
          <button name="action_confirm"
                  string="Confirmar"
                  type="object"
                  class="btn-primary"
                  invisible="state != 'draft'"/>

          <button name="action_set_done"
                  string="Marcar Completado"
                  type="object"
                  class="btn-secondary"
                  invisible="state != 'confirmed'"/>

          <button name="action_cancel"
                  string="Cancelar"
                  type="object"
                  class="btn-secondary"
                  invisible="state not in ['draft','confirmed']"/>

          <field name="state"
                 widget="statusbar"
                 statusbar_visible="draft,confirmed,done,cancel"/>
        </header>

        <sheet>
          <widget name="web_ribbon" title="Borrador" bg_color="text-bg-info" invisible="state != 'draft'"/>
          <widget name="web_ribbon" title="Confirmada" bg_color="text-bg-warning" invisible="state != 'confirmed'"/>
          <widget name="web_ribbon" title="Completada" bg_color="text-bg-success" invisible="state != 'done'"/>
          <widget name="web_ribbon" title="Cancelada" bg_color="text-bg-danger" invisible="state != 'cancel'"/>
          <widget name="web_ribbon" title="Facturado" bg_color="text-bg-success" invisible="invoicing_status != 'invoiced'"/>

          <div class="oe_button_box" name="button_box">
            <button name="action_view_linked_invoices"
                    type="object"
                    class="oe_stat_button"
                    icon="fa-file-text-o"
                    invisible="invoice_count == 0">
              <field name="invoice_count" widget="statinfo" string="Facturas"/>
            </button>
          </div>

          <div class="oe_title">
            <h1>
              <field name="name" class="o_inline"/>
            </h1>
            <div class="text-muted">
              <span>Orden de servicio vinculada a </span>
              <field name="sale_order_id"
                     class="o_inline"
                     placeholder="Sin cotización"
                     readonly="1"
                     options="{'no_create': True}"/>
            </div>
          </div>

          <notebook>
            <page string="Resumen" name="page_summary">
              <group>
                <group string="Cliente y Referencias">

                  <!-- Cliente inmutable cuando proviene de cotización -->
                  <field name="partner_id"
                         options="{'no_create': True}"
                         readonly="sale_order_id"/>

                  <!-- Generador: autofill por etiqueta Generador; mostrar solo contactos del cliente con esa etiqueta -->
                  <field name="generador_id"
                         options="{'no_create': True}"
                         domain="[
                           '&amp;',
                             ('category_id.name', '=ilike', 'Generador'),
                             '|', ('parent_id', '=', partner_id), ('id', '=', partner_id)
                         ]"
                         placeholder="(Sin contacto con etiqueta Generador)"/>

                  <!-- Responsable Generador: SOLO contactos del cliente -->
                  <field name="generador_responsable_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar contacto del cliente..."/>

                  <!-- Destinatario final: propagado desde venta; solo etiqueta Destino Final -->
                  <field name="destinatario_id"
                         options="{'no_create': True}"
                         domain="[('category_id.name', '=ilike', 'Destino Final')]"
                         placeholder="Seleccionar destinatario final..."/>

                  <field name="sale_order_id" string="Cotización" readonly="1" options="{'no_create': True}"/>
                  <field name="date_order"/>

                </group>

                <group string="Contacto y Recolección">

                  <!-- Nombre de contacto: select SOLO contactos del cliente -->
                  <field name="contact_partner_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar contacto del cliente..."/>

                  <!-- Teléfono: legacy (se llena desde el contacto), solo lectura para evitar captura manual -->
                  <field name="contact_phone" readonly="1"
                         placeholder="Se toma del contacto seleccionado"/>

                  <!-- Ubicación de recolección: select propagado desde venta; SOLO contactos del cliente -->
                  <field name="pickup_location_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar ubicación de recolección..."/>

                  <!-- Legacy pickup text oculto por defecto (compatibilidad) -->
                  <field name="pickup_location" invisible="1"/>

                  <field name="transportista_id" string="Transportista" options="{'no_create': True}"/>

                  <!-- Responsable Transportista: SOLO contactos del transportista -->
                  <field name="transportista_responsable_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', transportista_id), ('id', '=', transportista_id)]"
                         placeholder="Seleccionar contacto del transportista..."/>

                </group>
              </group>
            </page>

            <page string="Logística" name="page_logistics">
              <group>
                <group string="Unidad y Operador">
                  <field name="camion" string="Camión"/>
                  <field name="numero_placa" string="Placas"/>
                  <field name="chofer_id" string="Chofer" options="{'no_create': True}"/>
                </group>

                <group string="Remolques y Básculas">
                  <field name="remolque1" string="Remolque 1"/>
                  <field name="remolque2" string="Remolque 2"/>

                  <!-- NUEVO -->
                  <field name="bascula_1" string="Báscula 1"/>
                  <field name="bascula_2" string="Báscula 2"/>

                  <!-- Legacy oculto -->
                  <field name="numero_bascula" invisible="1"/>
                </group>
              </group>
            </page>

            <page string="Líneas de Servicio" name="page_lines">
              <field name="line_ids">
                <list editable="bottom">
                  <field name="product_id" column_invisible="1"/>
                  <field name="currency_id" column_invisible="1"/>

                  <field name="description" string="Residuo / Equivalente"/>
                  <field name="residue_type" string="Tipo"/>
                  <field name="plan_manejo" string="Plan de Manejo"/>
                  <field name="packaging_id" string="Embalaje"/>

                  <field name="price_unit"
                         string="Precio Unitario"
                         widget="monetary"
                         options="{'currency_field': 'currency_id'}"
                         invisible="not product_id"/>

                  <field name="capacity" string="Capacidad" invisible="not product_id"/>
                  <field name="weight_kg" string="Peso (kg)" invisible="not product_id"/>
                  <field name="product_uom_qty" string="Cantidad" invisible="not product_id"/>
                  <field name="product_uom" string="UoM" invisible="not product_id"/>
                </list>
              </field>
            </page>

            <page string="Observaciones" name="page_notes">
              <group string="Notas">
                <field name="observaciones"
                       nolabel="1"
                       placeholder="Ingrese observaciones adicionales..."
                       widget="text"/>
              </group>
            </page>

          </notebook>

        </sheet>
      </form>
    </field>
  </record>

</odoo>
