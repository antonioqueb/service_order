<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- =========================================================
       VISTA BÚSQUEDA (SEARCH)
       NOTA: Debe ir antes de 'action_service_order'
       ========================================================= -->
  <record id="view_service_order_search" model="ir.ui.view">
    <field name="name">service.order.search</field>
    <field name="model">service.order</field>
    <field name="arch" type="xml">
      <search string="Buscar Orden de Servicio">
        <!-- Campos de búsqueda rápida -->
        <field name="name" string="Folio"/>
        <field name="partner_id" string="Cliente"/>
        <field name="sale_order_id"/>
        <field name="transportista_id"/>
        <field name="generador_id"/>

        <separator/>

        <!-- Filtros Rápidos -->
        <filter string="Mis Órdenes" name="my_orders" domain="[('create_uid', '=', uid)]"/>
        <separator/>
        <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
        <filter string="Confirmadas" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
        <filter string="Completadas" name="done" domain="[('state', '=', 'done')]"/>
        <filter string="Canceladas" name="cancel" domain="[('state', '=', 'cancel')]"/>
        <separator/>
        <filter string="Pendiente Facturar" name="to_invoice" domain="[('invoicing_status', '=', 'no'), ('state', '=', 'done')]"/>
        <separator/>
        
        <!-- CORRECCIÓN: Filtro de fecha estándar -->
        <!-- Esto habilita el selector de periodos (Mes, Año, Trimestre) automáticamente -->
        <filter string="Fecha" name="filter_date_order" date="date_order"/>
        
        <!-- Agrupadores (Group By) -->
          <filter string="Cliente" name="group_partner" context="{'group_by': 'partner_id'}"/>
          <filter string="Generador" name="group_generador" context="{'group_by': 'generador_id'}"/>
          <filter string="Transportista" name="group_transportista" context="{'group_by': 'transportista_id'}"/>
          <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
          <filter string="Mes" name="group_date_month" context="{'group_by': 'date_order:month'}"/>
          <filter string="Frecuencia" name="group_frequency" context="{'group_by': 'service_frequency'}"/>
      </search>
    </field>
  </record>

  <!-- =========================================================
       ACCIÓN PRINCIPAL (WINDOW ACTION)
       ========================================================= -->
  <record id="action_service_order" model="ir.actions.act_window">
    <field name="name">Órdenes de Servicio</field>
    <field name="res_model">service.order</field>
    <field name="view_mode">list,form,pivot,graph</field>
    <!-- Referencia a la vista Search -->
    <field name="search_view_id" ref="view_service_order_search"/>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Cree su primera Orden de Servicio
      </p>
    </field>
  </record>

  <!-- =========================================================
       ACCIÓN DE SERVIDOR: FACTURACIÓN MASIVA
       ========================================================= -->
  <record id="action_service_order_mass_invoice" model="ir.actions.server">
    <field name="name">Crear Factura</field>
    <field name="model_id" ref="model_service_order"/>
    <field name="binding_model_id" ref="model_service_order"/>
    <field name="binding_view_types">list</field>
    <field name="state">code</field>
    <field name="code">
      if records:
          action = records.action_create_invoice()
    </field>
  </record>

  <!-- =========================================================
       MENÚ RAÍZ
       ========================================================= -->
  <record id="menu_service_order_root" model="ir.ui.menu">
    <field name="name">Servicios</field>
    <field name="sequence">10</field>
    <field name="action" ref="action_service_order"/>
    <field name="web_icon">service_order,static/description/icon.png</field>
  </record>

  <!-- =========================================================
       VISTA PIVOT (TABLA DINÁMICA)
       ========================================================= -->
  <record id="view_service_order_pivot" model="ir.ui.view">
    <field name="name">service.order.pivot</field>
    <field name="model">service.order</field>
    <field name="arch" type="xml">
      <pivot string="Análisis de Órdenes de Servicio" sample="1">
        <!-- Filas (Rows) -->
        <field name="partner_id" type="row"/>
        
        <!-- Columnas (Cols) -->
        <field name="date_order" interval="month" type="col"/>

        <!-- Medidas (Valores numéricos) -->
        <field name="total_weight_kg" type="measure" string="Peso (Kg)"/>
        <field name="total_product_qty" type="measure" string="Bultos/Cant."/>
        <field name="amount_untaxed" type="measure" string="Monto ($)"/>
      </pivot>
    </field>
  </record>

  <!-- =========================================================
       VISTA GRAPH
       ========================================================= -->
  <record id="view_service_order_graph" model="ir.ui.view">
    <field name="name">service.order.graph</field>
    <field name="model">service.order</field>
    <field name="arch" type="xml">
      <graph string="Ventas por Órdenes de Servicio" type="bar" sample="1">
        <field name="date_order" interval="month"/>
        <field name="total_weight_kg" type="measure"/>
      </graph>
    </field>
  </record>

  <!-- =========================================================
       VISTA LISTA
       ========================================================= -->
  <record id="view_service_order_list" model="ir.ui.view">
    <field name="name">service.order.list</field>
    <field name="model">service.order</field>
    <field name="type">list</field>
    <field name="arch" type="xml">
      <list string="Órdenes de Servicio" default_order="date_order desc">
        <field name="name" string="Folio" class="fw-bold"/>
        <field name="date_order" string="Fecha"/>
        <field name="partner_id" string="Cliente"/>
        <field name="sale_order_id" string="Cotización" readonly="1"/>
        
        <!-- Nuevas Columnas (Opcionales) -->
        <field name="total_weight_kg" string="Peso Total" sum="Total Peso" optional="show"/>
        <field name="total_product_qty" string="Cant. Total" sum="Total Items" optional="hide"/>

        <field name="state" widget="badge"
               decoration-info="state == 'draft'"
               decoration-warning="state == 'confirmed'"
               decoration-success="state == 'done'"
               decoration-danger="state == 'cancel'"/>
        <field name="invoicing_status" string="Facturación" widget="badge"
               decoration-info="invoicing_status == 'no'"
               decoration-warning="invoicing_status == 'draft'"
               decoration-success="invoicing_status == 'invoiced'"
               decoration-primary="invoicing_status == 'paid'"/>
        <field name="amount_untaxed" string="Monto Total" sum="Total"/>
      </list>
    </field>
  </record>

  <!-- =========================================================
       VISTA FORMULARIO
       ========================================================= -->
  <record id="view_service_order_form" model="ir.ui.view">
    <field name="name">service.order.form</field>
    <field name="model">service.order</field>
    <field name="type">form</field>
    <field name="arch" type="xml">
      <form string="Orden de Servicio">

        <header>
          <button name="action_confirm"
                  string="Confirmar"
                  type="object"
                  class="btn-primary"
                  invisible="state != 'draft'"/>

          <button name="action_set_done"
                  string="Marcar Completado"
                  type="object"
                  class="btn-secondary"
                  invisible="state != 'confirmed'"/>

          <button name="action_cancel"
                  string="Cancelar"
                  type="object"
                  class="btn-secondary"
                  invisible="state not in ['draft', 'confirmed', 'done'] or invoicing_status in ['invoiced', 'paid']"/>

          <button name="action_set_draft"
                  string="Restablecer a Borrador"
                  type="object"
                  class="btn-secondary"
                  invisible="state not in ['cancel', 'confirmed', 'done'] or invoicing_status in ['invoiced', 'paid']"/>

          <field name="state"
                 widget="statusbar"
                 statusbar_visible="draft,confirmed,done,cancel"/>
        </header>

        <sheet>
          <widget name="web_ribbon" title="Borrador" bg_color="text-bg-info" invisible="state != 'draft'"/>
          <widget name="web_ribbon" title="Confirmada" bg_color="text-bg-warning" invisible="state != 'confirmed'"/>
          <widget name="web_ribbon" title="Completada" bg_color="text-bg-success" invisible="state != 'done'"/>
          <widget name="web_ribbon" title="Cancelada" bg_color="text-bg-danger" invisible="state != 'cancel'"/>
          
          <widget name="web_ribbon" title="Pagado" bg_color="text-bg-primary" invisible="invoicing_status != 'paid'"/>
          <widget name="web_ribbon" title="Facturado" bg_color="text-bg-success" invisible="invoicing_status not in ['invoiced'] or invoicing_status == 'paid'"/>
          <widget name="web_ribbon" title="Fact. Borrador" bg_color="text-bg-warning" invisible="invoicing_status != 'draft'"/>

          <div class="oe_button_box" name="button_box">
            <button name="action_view_linked_invoices"
                    type="object"
                    class="oe_stat_button"
                    icon="fa-file-text-o"
                    invisible="invoice_count == 0">
              <field name="invoice_count" widget="statinfo" string="Facturas"/>
            </button>
          </div>

          <div class="oe_title">
            <h1>
              <field name="name" class="o_inline"/>
            </h1>
            <div class="text-muted">
              <span>Orden de servicio vinculada a </span>
              <field name="sale_order_id"
                     class="o_inline"
                     placeholder="Sin cotización"
                     readonly="1"
                     options="{'no_create': True}"/>
            </div>
          </div>

          <notebook>
            <page string="Resumen" name="page_summary">
              <group>
                <group string="Cliente y Referencias">
                  <field name="partner_id" options="{'no_create': True}" readonly="sale_order_id"/>

                  <field name="generador_id"
                         options="{'no_create': True}"
                         domain="[
                           '&amp;',
                             '|', ('parent_id', '=', partner_id), ('id', '=', partner_id),
                             ('category_id.name', 'ilike', 'Generador')
                         ]"
                         placeholder="(Sin contacto con etiqueta Generador)"/>

                  <field name="generador_responsable_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar contacto del cliente..."/>

                  <field name="destinatario_id"
                         options="{'no_create': True}"
                         domain="[('category_id.name', 'ilike', 'Destino Final')]"
                         placeholder="Seleccionar destinatario final..."/>

                  <field name="sale_order_id" string="Cotización" readonly="1" options="{'no_create': True}"/>
                  <field name="date_order"/>
                </group>

                <group string="Contacto y Recolección">
                  <field name="contact_partner_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar contacto del cliente..."/>

                  <field name="contact_phone" readonly="1"
                         placeholder="Se toma del contacto seleccionado"/>

                  <field name="pickup_location_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                         placeholder="Seleccionar ubicación de recolección..."/>

                  <field name="pickup_location" invisible="1"/>

                  <field name="transportista_id" string="Transportista" options="{'no_create': True}"/>

                  <field name="transportista_responsable_id"
                         options="{'no_create': True}"
                         domain="['|', ('parent_id', '=', transportista_id), ('id', '=', transportista_id)]"
                         placeholder="Seleccionar contacto del transportista..."/>
                </group>
              </group>
            </page>

            <page string="Logística" name="page_logistics">
              <group>
                <group string="Unidad y Operador">
                  <field name="camion" string="Camión"/>
                  <field name="numero_placa" string="Placas"/>
                  <field name="chofer_id" string="Chofer" options="{'no_create': True}"/>
                </group>

                <group string="Remolques y Básculas">
                  <field name="remolque1" string="Remolque 1"/>
                  <field name="remolque2" string="Remolque 2"/>
                  <field name="bascula_1" string="Báscula 1"/>
                  <field name="bascula_2" string="Báscula 2"/>
                  <field name="numero_bascula" invisible="1"/>
                  
                  <!-- Totales Calculados (Solo lectura) -->
                  <field name="total_weight_kg" readonly="1" class="fw-bold"/>
                  <field name="total_product_qty" readonly="1" class="fw-bold"/>
                </group>
              </group>
            </page>

            <page string="Líneas de Servicio" name="page_lines">
              <field name="line_ids">
                <list editable="bottom">
                  <field name="product_id" string="Producto/Servicio" options="{'no_create': True}"/>
                  <field name="currency_id" column_invisible="1"/>

                  <field name="description" string="Residuo / Equivalente"/>
                  <field name="residue_type" string="Tipo"/>
                  <field name="plan_manejo" string="Plan de Manejo"/>
                  <field name="packaging_id" string="Embalaje"/>

                  <field name="price_unit"
                         string="Precio Unitario"
                         widget="monetary"
                         options="{'currency_field': 'currency_id'}"
                         invisible="not product_id"/>

                  <field name="capacity" string="Capacidad" invisible="not product_id"/>
                  <field name="weight_kg" string="Peso (kg)" sum="Total Kg" invisible="not product_id"/>
                  <field name="product_uom_qty" string="Cantidad" sum="Total Cantidad" invisible="not product_id"/>
                  <field name="product_uom" string="UoM" invisible="not product_id"/>
                </list>
              </field>
            </page>

            <page string="Observaciones" name="page_notes">
              <group string="Notas">
                <field name="observaciones"
                       nolabel="1"
                       placeholder="Ingrese observaciones adicionales..."
                       widget="text"/>
              </group>
            </page>

          </notebook>

        </sheet>
      </form>
    </field>
  </record>

</odoo>